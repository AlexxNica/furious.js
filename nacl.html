<!DOCTYPE html>
<html>
	<head>
		<title>NumJS PNaCl Backend Demo</title>
	</head>
	<body>
		<div>
			<script type="text/javascript">
				(function () {
					var allocator = (function(){
						var messageId = 0;
						var arrayId = 0;

						function newMessageId() {
							var id = messageId;
							messageId = (messageId+1)|0;
							return id;
						}

						function newArrayId() {
							var id = arrayId;
							arrayId = (arrayId+1)|0;
							return id;
						}

						return {
							newMessageId: newMessageId,
							newArrayId: newArrayId
						}
					}());
				
					function dotProductJS(xArray, yArray) {
						var n = xArray.length;
						var s = 0.0;
						for (var i = 0; i < n; ++i) {
							s += xArray[i] * yArray[i];
						}
						return s;
					}

					function hasPNaCl() {
						try {
							return (typeof navigator.mimeTypes['application/x-pnacl']) !== "undefined";
						} catch (e) {
							return false;
						}
					}

					function hasSIMD() {
						return typeof SIMD !== 'undefined';
					}

					console.log('SIMD: ' + (hasSIMD() ? 'supported' : 'not supported'));

					if (hasPNaCl()) {
						console.log("PNaCl: supported");
						var pnacl = document.createElement('object');
						var timestamp = 0.0;
						var iteration = 0;
						pnacl.width = 0;
						pnacl.height = 0;
						pnacl.data = "numjs.nmf";
						pnacl.type = "application/x-pnacl";
						pnacl.addEventListener('load', function () {
							timestamp = performance.now();
							for (var i = 0; i < 10; i++) {
								var xId = allocator.newArrayId();
								pnacl.postMessage({
									"id": allocator.newMessageId(),
									"command": "create",
									"shape": new Uint32Array([1024, 1024]).buffer,
									"type": "f64",
									"out": xId
								});
								pnacl.postMessage({
									"id": allocator.newMessageId(),
									"command": "get-buffer",
									"in": xId
								});
								pnacl.postMessage({
									"id": allocator.newMessageId(),
									"command": "release",
									"in": xId
								});
							}
						}, true);
						pnacl.addEventListener('message', function (message) {
							console.log("PNaCl message (id: " + message.data.id + ") has status: " + message.data.status);
						}, true);
						document.body.appendChild(pnacl);
					} else {
						console.log("PNaCl: not supported");
						window.sum = 0;
						for (var i = 0; i < 10; i++) {
							timestamp = performance.now();
							var s = dotProductJS(x, y);
							var ping = performance.now() - timestamp;
							console.log("JS: " + ping.toFixed(3) + " ms");
							window.sum += s;
						}
					}
				}());
			</script>
		</div>
	</body>
</html>
