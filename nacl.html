<!DOCTYPE html>
<html>
	<head>
		<title>NumJS PNaCl Backend Demo</title>
	</head>
	<body>
		<div>
			<script type="text/javascript">
				(function () {
					var allocator = (function(){
						var messageId = 0;
						var arrayId = 0;

						function newMessageId() {
							var id = messageId;
							messageId = (messageId+1)|0;
							return id;
						}

						function newArrayId() {
							var id = arrayId;
							arrayId = (arrayId+1)|0;
							return id;
						}

						return {
							newMessageId: newMessageId,
							newArrayId: newArrayId
						}
					}());
				
					function dotProductJS(xArray, yArray) {
						var n = xArray.length;
						var s = 0.0;
						for (var i = 0; i < n; ++i) {
							s += xArray[i] * yArray[i];
						}
						return s;
					}

					function hasPNaCl() {
						try {
							return (typeof navigator.mimeTypes['application/x-pnacl']) !== "undefined";
						} catch (e) {
							return false;
						}
					}

					function hasSIMD() {
						return typeof SIMD !== 'undefined';
					}

					console.log('SIMD: ' + (hasSIMD() ? 'supported' : 'not supported'));

					if (hasPNaCl()) {
						console.log("PNaCl: supported");
						var pnacl = document.createElement('object');
						var timestamp = 0.0;
						var iteration = 0;
						pnacl.width = 0;
						pnacl.height = 0;
						pnacl.data = "numjs.nmf";
						pnacl.type = "application/x-pnacl";
						pnacl.addEventListener('load', function () {
							timestamp = performance.now();
							var x = new Float64Array(5);
							var y = new Float64Array(5);
							for (var i = 0; i < 5; i++) {
								x[i] = i+1;
								y[i] = 2*i-1;
							}
							var xId = allocator.newArrayId();
							var yId = allocator.newArrayId();
							var sumId = allocator.newArrayId();
							var diffId = allocator.newArrayId();
							var prodId = allocator.newArrayId();
							var fracId = allocator.newArrayId();
							pnacl.postMessage({
								"id": allocator.newMessageId(),
								"command": "create-from-buffer",
								"shape": new Uint32Array([5]).buffer,
								"datatype": "f64",
								"buffer": x.buffer,
								"out": xId
							});
							pnacl.postMessage({
								"id": allocator.newMessageId(),
								"command": "create-from-buffer",
								"shape": new Uint32Array([5]).buffer,
								"datatype": "f64",
								"buffer": y.buffer,
								"out": yId
							});
							pnacl.postMessage({
								"id": allocator.newMessageId(),
								"command": "get-buffer",
								"in": xId
							});
							pnacl.postMessage({
								"id": allocator.newMessageId(),
								"command": "get-buffer",
								"in": yId
							});
							pnacl.postMessage({
								"id": allocator.newMessageId(),
								"command": "add",
								"a": xId,
								"b": yId,
								"out": sumId
							});
							pnacl.postMessage({
								"id": allocator.newMessageId(),
								"command": "sub",
								"a": xId,
								"b": yId,
								"out": diffId
							});
							pnacl.postMessage({
								"id": allocator.newMessageId(),
								"command": "mul",
								"a": xId,
								"b": yId,
								"out": prodId
							});
							pnacl.postMessage({
								"id": allocator.newMessageId(),
								"command": "div",
								"a": xId,
								"b": yId,
								"out": fracId
							});
							pnacl.postMessage({
								"id": allocator.newMessageId(),
								"command": "release",
								"in": xId
							});
							pnacl.postMessage({
								"id": allocator.newMessageId(),
								"command": "release",
								"in": yId
							});
							pnacl.postMessage({
								"id": allocator.newMessageId(),
								"command": "get-buffer",
								"in": sumId
							});
							pnacl.postMessage({
								"id": allocator.newMessageId(),
								"command": "release",
								"in": sumId
							});
							pnacl.postMessage({
								"id": allocator.newMessageId(),
								"command": "get-buffer",
								"in": diffId
							});
							pnacl.postMessage({
								"id": allocator.newMessageId(),
								"command": "release",
								"in": diffId
							});
							pnacl.postMessage({
								"id": allocator.newMessageId(),
								"command": "get-buffer",
								"in": prodId
							});
							pnacl.postMessage({
								"id": allocator.newMessageId(),
								"command": "release",
								"in": prodId
							});
							pnacl.postMessage({
								"id": allocator.newMessageId(),
								"command": "get-buffer",
								"in": fracId
							});
							pnacl.postMessage({
								"id": allocator.newMessageId(),
								"command": "release",
								"in": fracId
							});
						}, true);
						pnacl.addEventListener('message', function (message) {
							console.log("PNaCl message (id: " + message.data.id + ") has status: " + message.data.status);
							if (typeof message.data.buffer !== 'undefined') {
								var array = new Float64Array(message.data.buffer);
								for (var i = 0; i < array.length; i++) {
									console.log(i + ": " + array[i]);
								}
							}
						}, true);
						document.body.appendChild(pnacl);
					} else {
						console.log("PNaCl: not supported");
						window.sum = 0;
						for (var i = 0; i < 10; i++) {
							timestamp = performance.now();
							var s = dotProductJS(x, y);
							var ping = performance.now() - timestamp;
							console.log("JS: " + ping.toFixed(3) + " ms");
							window.sum += s;
						}
					}
				}());
			</script>
		</div>
	</body>
</html>
